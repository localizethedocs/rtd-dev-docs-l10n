

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Secure API access from builders" />
<meta property="og:type" content="website" />
<meta property="og:url" content="design/secure-api-access-from-builders.html" />
<meta property="og:site_name" content="Read the Docs Documentation" />
<meta property="og:description" content="Goals: Provide a secure way for builders to access the API., Limit the access of the tokens to the minimum required.. Non-goals: Migrate builds to use API V3, Implement this mechanism in API V3, Expose it to users. All these changes can be made in the future, if needed. Current state: Currently, ..." />
<meta property="og:image" content="https://docs.readthedocs.io/en/latest/_static/img/logo-opengraph.png" />
<meta property="og:image:alt" content="Read the Docs Documentation" />
<meta name="description" content="Goals: Provide a secure way for builders to access the API., Limit the access of the tokens to the minimum required.. Non-goals: Migrate builds to use API V3, Implement this mechanism in API V3, Expose it to users. All these changes can be made in the future, if needed. Current state: Currently, ..." />
<meta name="twitter:card" content="summary_large_image" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure API access from builders &mdash; Read the Docs developer documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=ca6f9a36" />
      <link rel="stylesheet" type="text/css" href="../_static/css/sphinx_prompt_css.css?v=351d85e3" />

  
    <link rel="canonical" href="https://projects.localizethedocs.org/rtd-dev-docs-l10n/design/secure-api-access-from-builders.html" />
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=7dd903f3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/translations.js?v=beaddf03"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/js/expand_tabs.js?v=1e151f68"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="sphinxcontrib-jquery" href="sphinx-jquery.html" />
    <link rel="prev" title="Refactor RemoteRepository object" href="refactor-remote-repository.html" />

   

  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Read the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-of-conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../issue-labels.html">Overview of issue labels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design documents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="apiv3.html">API v3 design document</a></li>
<li class="toctree-l2"><a class="reference internal" href="better-doc-urls-handling.html">Better handling of docs URLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-images.html">Build images</a></li>
<li class="toctree-l2"><a class="reference internal" href="embed-api.html">Embed APIv3</a></li>
<li class="toctree-l2"><a class="reference internal" href="file-tree-diff.html">Version file tree diff</a></li>
<li class="toctree-l2"><a class="reference internal" href="flyout-redesign.html">Flyout Redesign Design Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="future-builder.html">Future builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="in-doc-search-ui.html">In-doc search UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-notifications-system.html">Notification system: a new approach after lot of discussions</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-search-api.html">New search API</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-sphinx-guides.html">Proposed contents for new Sphinx guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizations.html">Organizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="pr-builder.html">Design of pull request builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="privacy-levels.html">Privacy levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="redirects.html">Improving redirects</a></li>
<li class="toctree-l2"><a class="reference internal" href="refactor-remote-repository.html">Refactor <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> object</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Secure API access from builders</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#goals">Goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-goals">Non-goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#current-state">Current state</a></li>
<li class="toctree-l3"><a class="reference internal" href="#proposed-solution">Proposed solution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#technical-implementation">Technical implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#flow">Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#why-attach-tokens-to-users">Why attach tokens to users?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keeping-backwards-compatibility">Keeping backwards compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#possible-issues">Possible issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#alternative-implementation-with-django-rest-framework-api-key">Alternative implementation with Django REST Framework API Key</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="#future-work">Future work</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sphinx-jquery.html">sphinxcontrib-jquery</a></li>
<li class="toctree-l2"><a class="reference internal" href="system-packages.html">Allow installation of system packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="telemetry.html">Collect data about builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="theme-context.html">Read the Docs data passed to Sphinx build context</a></li>
<li class="toctree-l2"><a class="reference internal" href="yaml-file.html">YAML configuration file</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Development installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">Development guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design.html">Designing Read the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs.html">Building and contributing to documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../style-guide.html">Documentation style guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../front-end.html">Front-end development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i18n.html">Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migrations.html">Database migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server-side-search.html">Server side search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../search-integration.html">Server side search integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws-temporary-credentials.html">AWS temporary credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../subscriptions.html">Subscriptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../github-app.html">GitHub App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../settings.html">Interesting settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests.html">Testing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Read the Docs developer documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Design documents</a></li>
      <li class="breadcrumb-item active">Secure API access from builders</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/readthedocs/readthedocs.org/blob/main/docs/dev/design/secure-api-access-from-builders.rst" class="fa fa-github"> 在 GitHub 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="secure-api-access-from-builders">
<h1>Secure API access from builders<a class="headerlink" href="#secure-api-access-from-builders" title="Link to this heading"></a></h1>
<section id="goals">
<h2>Goals<a class="headerlink" href="#goals" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Provide a secure way for builders to access the API.</p></li>
<li><p>Limit the access of the tokens to the minimum required.</p></li>
</ul>
</section>
<section id="non-goals">
<h2>Non-goals<a class="headerlink" href="#non-goals" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Migrate builds to use API V3</p></li>
<li><p>Implement this mechanism in API V3</p></li>
<li><p>Expose it to users</p></li>
</ul>
<p>All these changes can be made in the future, if needed.</p>
</section>
<section id="current-state">
<h2>Current state<a class="headerlink" href="#current-state" title="Link to this heading"></a></h2>
<p>Currently, we access the API V2 from the builders using the credentials of the &quot;builder&quot; user.
This user is a superuser, it has access to all projects,
write access to the API, access to restricted endpoints, and restricted fields.</p>
<p>The credentials are hardcoded in our settings file,
so if there is a vulnerability that allows users to have access to the settings file,
the attacker will have access to the credentials of the &quot;builder&quot; user,
giving them full access to the API and all projects.</p>
</section>
<section id="proposed-solution">
<h2>Proposed solution<a class="headerlink" href="#proposed-solution" title="Link to this heading"></a></h2>
<p>Instead of using the credential of a super user to access the API,
we will create a temporal token attached to a project, and one of the owners of the project.
This way this token will have access to the given project only for a limited period of time.</p>
<p>This token will be generated from the webs,
and passed to the builders via the celery task,
where it can be used to access the API.
Once the build has finished, this token will be revoked.</p>
</section>
<section id="technical-implementation">
<h2>Technical implementation<a class="headerlink" href="#technical-implementation" title="Link to this heading"></a></h2>
<p>We will use the <a class="reference external" href="https://james1345.github.io/django-rest-knox/">rest-knox</a> package,
this package is recommended by the DRF documentation,
since the default token implementation of DRF is very basic,
some relevant features of knox are:</p>
<ul class="simple">
<li><p>Support for several tokens per user.</p></li>
<li><p>Tokens are stored in a hashed format in the database.
We don't have access the tokens after they are created.</p></li>
<li><p>Tokens can have an expiration date.</p></li>
<li><p>Tokens can be created with a prefix (rtd_xxx) (unreleased)</p></li>
<li><p>Support for custom token model (unreleased)</p></li>
</ul>
<p>We won't expose the token creation view directly,
since we can create the tokens from the webs,
and this isn't exposed to users.</p>
<p>The view to revoke the token will be exposed,
since we need it to revoke the token once the build has finished.</p>
<p>From the API, we just need to add the proper permission and authentication classes
to the views we want to support.</p>
<p>To differentiate from a normal user and a token authed user,
we will have access to the token via the <code class="docutils literal notranslate"><span class="pre">request.auth</span></code> attribute in the API views,
this will also be used to get the attached projects to filter the querysets.</p>
<p>The knox package allows us to provide our own token model,
this will be useful to add our own fields to the token model.
Fields like the projects attached to the token,
or access to all projects the user has access to, etc.</p>
</section>
<section id="flow">
<h2>Flow<a class="headerlink" href="#flow" title="Link to this heading"></a></h2>
<p>The flow of creation and usage of the token will be:</p>
<ul class="simple">
<li><p>Create a token from the webs when a build is triggered.
The triggered project will be attached to the token,
if the build was triggered by a user, that user will be attached to the token,
otherwise the token will be attached to one of the owners of the project.</p></li>
<li><p>The token will be created with an expiration date
of 3 hours, this should be enough for the build to finish.
We could also make this dynamic depending of the project.</p></li>
<li><p>Pass the token to the builder via the celery task.</p></li>
<li><p>Pass the token to all places where the API is used.</p></li>
<li><p>Revoke the token when the build has finished.
This is done by hitting the revoke endpoint.</p></li>
<li><p>In case the revoke endpoint fails, the token will expire in 3 hours.</p></li>
</ul>
</section>
<section id="why-attach-tokens-to-users">
<h2>Why attach tokens to users?<a class="headerlink" href="#why-attach-tokens-to-users" title="Link to this heading"></a></h2>
<p>Attaching tokens to users will ease the implementation,
since we can reuse the code from knox package.</p>
<p>Attaching tokens to projects only is possible,
but it will require to manage the authentication manually.
This is since Knox requires a user to be attached to the token,
and this user is used in their <code class="docutils literal notranslate"><span class="pre">TokenAuthentication</span></code> class.
An alternative is to use the DRF API key package, which doesn't require a user,
but then if we wanted to extend this functionality to our normal APIs, we will have
to implement the authentication manually.</p>
</section>
<section id="keeping-backwards-compatibility">
<h2>Keeping backwards compatibility<a class="headerlink" href="#keeping-backwards-compatibility" title="Link to this heading"></a></h2>
<p>Access to write API V2 is restricted to superusers,
and was used only from the builders.
So we don't need to keep backwards compatibility for authed requests,
but we need to keep the old implementation working while we deploy the new one.</p>
</section>
<section id="possible-issues">
<h2>Possible issues<a class="headerlink" href="#possible-issues" title="Link to this heading"></a></h2>
<p>Some of the features that we may need are not released yet,
we need the custom token model feature, specially.</p>
<p>There is a race condition when using the token,
and the user that is attached to that token is removed from the project.
This is, if the user is removed while the build is running,
the builders won't be able to access the API.
We could avoid this by not relying on the user attached to the token,
only on the projects attached to it (this would be for our build APIs only).</p>
</section>
<section id="alternative-implementation-with-django-rest-framework-api-key">
<h2>Alternative implementation with Django REST Framework API Key<a class="headerlink" href="#alternative-implementation-with-django-rest-framework-api-key" title="Link to this heading"></a></h2>
<p>Instead of using knox, we can use <a class="reference external" href="https://florimondmanca.github.io/djangorestframework-api-key/">DRF API key</a>,
it has the same features as knox, with the exception of:</p>
<ul class="simple">
<li><p>It is only used for authorization,
it can't be used for authentication (or it can't be out of the box).</p></li>
<li><p>It doesn't expose views to revoke the tokens (but this should be easy to manually implement)</p></li>
<li><p>Changing the behaviour of some things require sub-classing instead of defining settings.</p></li>
<li><p>It supports several token models (not just one like knox).</p></li>
<li><p>All features that we need are already released.</p></li>
</ul>
<p>The implementation will be very similar to the one described for knox,
with the exception that tokens won't be attached to users,
but just a project. And we won't be needing to handle authentication,
since the token itself will grant access to the projects.</p>
<p>To avoid breaking builders,
we need to be able to make the old and the new implementation work together,
this is, allow authentication and handle tokens at the same time.
This means passing valid user credentials together with the token,
this &quot;feature&quot; can be removed in the next deploy
(with knox we also need to handle both implementations,
but it doesn't require passing credentials with the token,
since it also handles authentication).</p>
</section>
<section id="decision">
<h2>Decision<a class="headerlink" href="#decision" title="Link to this heading"></a></h2>
<p>Because the required features from knox are not released yet,
we have decided to use DRF API key instead.</p>
</section>
<section id="future-work">
<h2>Future work<a class="headerlink" href="#future-work" title="Link to this heading"></a></h2>
<p>This work can be extended to API V3, and be exposed to users in the future.
We only need to take into consideration that the token model will be shared by both,
API V2 and API V3 if using knox, if we use API key, we can have different token models
for each use case.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="refactor-remote-repository.html" class="btn btn-neutral float-left" title="Refactor RemoteRepository object" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="sphinx-jquery.html" class="btn btn-neutral float-right" title="sphinxcontrib-jquery" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 Read the Docs, Inc &amp; contributors。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>