

<!DOCTYPE html>
<html class="writer-html5" lang="zh-TW" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Refactor RemoteRepository object" />
<meta property="og:type" content="website" />
<meta property="og:url" content="design/refactor-remote-repository.html" />
<meta property="og:site_name" content="Read the Docs Documentation" />
<meta property="og:description" content="This document describes the current usage of RemoteRepository objects and proposes a new normalized modeling. Goals: De-duplicate data stored in our database., Save only one RemoteRepository per GitHub repository., Use an intermediate table between RemoteRepository and User to store associated re..." />
<meta property="og:image" content="https://docs.readthedocs.io/en/latest/_static/img/logo-opengraph.png" />
<meta property="og:image:alt" content="Read the Docs Documentation" />
<meta name="description" content="This document describes the current usage of RemoteRepository objects and proposes a new normalized modeling. Goals: De-duplicate data stored in our database., Save only one RemoteRepository per GitHub repository., Use an intermediate table between RemoteRepository and User to store associated re..." />
<meta name="twitter:card" content="summary_large_image" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Refactor RemoteRepository object &mdash; Read the Docs developer documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=ca6f9a36" />
      <link rel="stylesheet" type="text/css" href="../_static/css/sphinx_prompt_css.css?v=351d85e3" />

  
    <link rel="canonical" href="https://projects.localizethedocs.org/rtd-dev-docs-l10n/design/refactor-remote-repository.html" />
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=80428b84"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
      <script src="../_static/translations.js?v=cbf116e0"></script>
      <script src="../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../_static/js/expand_tabs.js?v=1e151f68"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜尋" href="../search.html" />
    <link rel="next" title="Secure API access from builders" href="secure-api-access-from-builders.html" />
    <link rel="prev" title="Improving redirects" href="redirects.html" />

   

  

<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">一般</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Read the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-of-conduct.html">行為守則</a></li>
<li class="toctree-l1"><a class="reference internal" href="../issue-labels.html">議題標籤概覽</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">路線圖</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">設計文件</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="apiv3.html">API v3 design document</a></li>
<li class="toctree-l2"><a class="reference internal" href="better-doc-urls-handling.html">Better handling of docs URLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-images.html">Build images</a></li>
<li class="toctree-l2"><a class="reference internal" href="embed-api.html">Embed APIv3</a></li>
<li class="toctree-l2"><a class="reference internal" href="file-tree-diff.html">Version file tree diff</a></li>
<li class="toctree-l2"><a class="reference internal" href="flyout-redesign.html">Flyout Redesign Design Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="future-builder.html">Future builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="in-doc-search-ui.html">In-doc search UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-notifications-system.html">Notification system: a new approach after lot of discussions</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-search-api.html">New search API</a></li>
<li class="toctree-l2"><a class="reference internal" href="new-sphinx-guides.html">Proposed contents for new Sphinx guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizations.html">Organizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="pr-builder.html">Design of pull request builder</a></li>
<li class="toctree-l2"><a class="reference internal" href="privacy-levels.html">Privacy levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="redirects.html">Improving redirects</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Refactor <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> object</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#goals">Goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-goals">Non-goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#current-implementation">Current implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#where-remoterepository-is-used">Where <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> is used?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#new-normalized-implementation">New normalized implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#use-this-modeling-for-sso">Use this modeling for SSO</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rollout-plan">Rollout plan</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="secure-api-access-from-builders.html">Secure API access from builders</a></li>
<li class="toctree-l2"><a class="reference internal" href="sphinx-jquery.html">sphinxcontrib-jquery</a></li>
<li class="toctree-l2"><a class="reference internal" href="system-packages.html">Allow installation of system packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="telemetry.html">Collect data about builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="theme-context.html">Read the Docs data passed to Sphinx build context</a></li>
<li class="toctree-l2"><a class="reference internal" href="yaml-file.html">YAML configuration file</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">開發</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install.html">開發安裝</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">開發指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design.html">設計 Read the Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs.html">Building and contributing to documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../style-guide.html">文件風格指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../front-end.html">前端開發</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i18n.html">國際化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migrations.html">資料庫遷移</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server-side-search.html">Server side search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../search-integration.html">Server side search integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws-temporary-credentials.html">AWS temporary credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../subscriptions.html">訂閱</a></li>
<li class="toctree-l1"><a class="reference internal" href="../github-app.html">GitHub App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../settings.html">有趣的設定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests.html">測試</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Read the Docs developer documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">設計文件</a></li>
      <li class="breadcrumb-item active">Refactor <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> object</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/readthedocs/readthedocs.org/blob/main/docs/dev/design/refactor-remote-repository.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="refactor-remoterepository-object">
<h1>Refactor <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> object<a class="headerlink" href="#refactor-remoterepository-object" title="連結到這個標頭"></a></h1>
<p>This document describes the current usage of <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> objects and proposes a new normalized modeling.</p>
<section id="goals">
<h2>Goals<a class="headerlink" href="#goals" title="連結到這個標頭"></a></h2>
<ul class="simple">
<li><p>De-duplicate data stored in our database.</p></li>
<li><p>Save only one <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> per GitHub repository.</p></li>
<li><p>Use an intermediate table between <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> and <code class="docutils literal notranslate"><span class="pre">User</span></code> to store associated remote data for the specific user.</p></li>
<li><p>Make this model usable from our SSO implementation (adding <code class="docutils literal notranslate"><span class="pre">remote_id</span></code> field in <code class="docutils literal notranslate"><span class="pre">Remote</span></code> objects).</p></li>
<li><p>Use Post <code class="docutils literal notranslate"><span class="pre">JSONField</span></code> to store associated <code class="docutils literal notranslate"><span class="pre">json</span></code> remote data.</p></li>
<li><p>Make <code class="docutils literal notranslate"><span class="pre">Project</span></code> connect directly to <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> without being linked to a specific <code class="docutils literal notranslate"><span class="pre">User</span></code>.</p></li>
<li><p>Do not disconnect <code class="docutils literal notranslate"><span class="pre">Project</span></code> and <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> when a user delete/disconnects their account.</p></li>
</ul>
</section>
<section id="non-goals">
<h2>Non-goals<a class="headerlink" href="#non-goals" title="連結到這個標頭"></a></h2>
<ul class="simple">
<li><p>Keep <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> in sync with GitHub repositories.</p></li>
<li><p>Delete <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> objects deleted from GitHub.</p></li>
<li><p>Listen to GitHub events to detect <code class="docutils literal notranslate"><span class="pre">full_name</span></code> changes and update our objects.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">備註</p>
<p>We may need/want some of these non-goals in the future.
They are just outside the scope of this document.</p>
</div>
</section>
<section id="current-implementation">
<h2>Current implementation<a class="headerlink" href="#current-implementation" title="連結到這個標頭"></a></h2>
<p>When a user connect their account to a social account, we create a</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">allauth.socialaccount.models.SocialAccount</span></code>
* basic information (provider, last login, etc)
* provider's specific data saved in a JSON under <code class="docutils literal notranslate"><span class="pre">extra_data</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allauthsocialaccount.models.SocialToken</span></code>
* token to hit the API on behalf the user</p></li>
</ul>
<p>We <em>don't create</em> any <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> at this point.
They are created when the user jumps into &quot;Import Project&quot; page and hit the circled arrows.
It triggers <code class="docutils literal notranslate"><span class="pre">sync_remote_repostories</span></code> task in background that updates or creates <code class="docutils literal notranslate"><span class="pre">RemoteRepositories</span></code>,
but <strong>it does not delete</strong> them (after <a class="reference external" href="https://github.com/readthedocs/readthedocs.org/pull/7183">#7183</a> and <a class="reference external" href="https://github.com/readthedocs/readthedocs.org/pull/7310">#7310</a> got merged, they will be deleted).
One <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> is created per repository the <code class="docutils literal notranslate"><span class="pre">User</span></code> has access to.</p>
<div class="admonition note">
<p class="admonition-title">備註</p>
<p>In corporate, we are automatically syncing <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> and <code class="docutils literal notranslate"><span class="pre">RemoteOganization</span></code>
at signup (foreground) and login (background) via a signal. We should eventually move these to community.</p>
</div>
</section>
<section id="where-remoterepository-is-used">
<h2>Where <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> is used?<a class="headerlink" href="#where-remoterepository-is-used" title="連結到這個標頭"></a></h2>
<ul class="simple">
<li><p>List of available repositories to import under &quot;Import Project&quot;</p></li>
<li><p>Show a &quot;+&quot;, &quot;External Arrow&quot; or a &quot;Lock&quot; sign next to the element in the list
* +: it's available to be imported
* External Arrow: the repository is already imported (see <a class="reference external" href="https://github.com/readthedocs/readthedocs.org/blob/56253cb786945c9fe53a034a4433f10672ae8a4f/readthedocs/oauth/models.py#L182-L204">RemoteRepository.matches</a> method)
* Lock: user doesn't have (admin) permissions to import this repository (uses <code class="docutils literal notranslate"><span class="pre">RemoteRepository.private</span></code> and <code class="docutils literal notranslate"><span class="pre">RemoteRepository.admin</span></code>)</p></li>
<li><p>Avatar URL in the list of project available to import</p></li>
<li><p><a class="reference external" href="https://github.com/readthedocs/readthedocs.org/blob/56253cb786945c9fe53a034a4433f10672ae8a4f/readthedocs/oauth/utils.py#L26-L62">Update webhook</a> when user clicks &quot;Resync webhook&quot; from the <span class="guilabel">Admin</span> &gt; <span class="guilabel">Integrations</span> tab</p></li>
<li><p><a class="reference external" href="https://github.com/readthedocs/readthedocs.org/blob/56253cb786945c9fe53a034a4433f10672ae8a4f/readthedocs/projects/tasks.py#L1852-L1956">Send build status</a> when building Pull Requests</p></li>
</ul>
</section>
<section id="new-normalized-implementation">
<h2>New normalized implementation<a class="headerlink" href="#new-normalized-implementation" title="連結到這個標頭"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ManyToMany</span></code> relation <code class="docutils literal notranslate"><span class="pre">RemoteRepository.users</span></code> will be changed to be <code class="docutils literal notranslate"><span class="pre">ManyToMany(through='RemoteRelation')</span></code>
<a class="reference external" href="https://docs.djangoproject.com/en/2.2/topics/db/models/#extra-fields-on-many-to-many-relationships">to add extra fields in the relation</a> that are specific only for the User.
Allows us to have <em>only one</em> <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> per GitHub repository with multiple relationships to <code class="docutils literal notranslate"><span class="pre">User</span></code>.</p>
<p>With this modeling, we can avoid the disconnection <code class="docutils literal notranslate"><span class="pre">Project</span></code> and <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> only by removing the <code class="docutils literal notranslate"><span class="pre">RemoteRelation</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">備註</p>
<p>All the points mentioned in the previous section may need to be adapted to use the new normalized modeling.
However, it may be only field renaming or small query changes over new fields.</p>
</div>
<section id="use-this-modeling-for-sso">
<h3>Use this modeling for SSO<a class="headerlink" href="#use-this-modeling-for-sso" title="連結到這個標頭"></a></h3>
<p>We can get the list of <code class="docutils literal notranslate"><span class="pre">Project</span></code> where a user as access:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">admin_remote_repositories</span> <span class="o">=</span> <span class="n">RemoteRepository</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">users__contains</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
    <span class="n">users__remoterelation__admin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># False for read-only access</span>
<span class="p">)</span>
<span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">remote_repository__in</span><span class="o">=</span><span class="n">admin_remote_repositories</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="rollout-plan">
<h2>Rollout plan<a class="headerlink" href="#rollout-plan" title="連結到這個標頭"></a></h2>
<p>Due the constraints we have in the <code class="docutils literal notranslate"><span class="pre">RemoteRepository</span></code> table and its size,
we can't just do the data migration at the same time of the deploy.
Because of this we need to be more creative here and find a way to re-sync the data from VCS providers,
while the site continue working.</p>
<p>To achieve this, we thought on following this steps:</p>
<p>1. modify all the Python code to use the new modeling in .org and .com (will help us to find out bugs locally in an easier way)
1. QA this locally with test data
1. enable Django signal to re-sync RemoteRepository on login async (we already have this in .com). New active users will have updated data immediately
1. spin up a new instance with the new refactored code
1. run migrations to create a new table for <code class="xref py py-obj docutils literal notranslate"><span class="pre">RemoteRepository</span></code>
1. re-sync everything from VCS providers into the new table for 1-week or so
1. dump-n-load <code class="xref py py-obj docutils literal notranslate"><span class="pre">Project</span> <span class="pre">-</span> <span class="pre">RemoteRepository</span></code> relations
1. create a migration to use the new table with synced data
1. deploy new code once the sync is finished</p>
<p>See these issues for more context:
* <a class="reference external" href="https://github.com/readthedocs/readthedocs.org/pull/7536#issuecomment-724102640">https://github.com/readthedocs/readthedocs.org/pull/7536#issuecomment-724102640</a>
* <a class="reference external" href="https://github.com/readthedocs/readthedocs.org/pull/7675#issuecomment-732756118">https://github.com/readthedocs/readthedocs.org/pull/7675#issuecomment-732756118</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="redirects.html" class="btn btn-neutral float-left" title="Improving redirects" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="secure-api-access-from-builders.html" class="btn btn-neutral float-right" title="Secure API access from builders" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Read the Docs, Inc &amp; contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>